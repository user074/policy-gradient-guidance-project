<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Policy Gradient Guidance (PGG) â€” Testâ€‘Time Control for PPO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Open Graph -->
  <meta property="og:title" content="Policy Gradient Guidance (PGG)">
  <meta property="og:description" content="Adding Classifier-Free Guidance to PPO for Test-Time Control">
  <meta property="og:image" content="assets/teaser.png">
  <meta property="og:type" content="website">

  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="./static/css/bulma.min.css">
  <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="./static/css/index.css">
  <link rel="icon" href="./static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="./static/js/fontawesome.all.min.js"></script>
  <script src="./static/js/bulma-carousel.min.js"></script>
  <script src="./static/js/bulma-slider.min.js"></script>
  <script src="./static/js/index.js"></script>
</head>
<body>

  <!-- ========================================================= -->
  <!--  HERO BANNER                                              -->
  <!-- ========================================================= -->
  <section class="hero is-fullheight-with-navbar">
    <div class="hero-body is-justify-content-center is-align-items-center">
      <div class="container has-text-centered">
        <h1 class="title is-1">Policy Gradient Guidance Enables Testâ€‘Time Control</h1>
        <h2 class="subtitle is-4">Adding Classifier-Free Guidance to PPO for Test-Time Control</h2>

        <!-- AUTHORS INLINE -->
        <p class="is-size-6 mb-1">
          <a href="https://user074.github.io/" target="_blank">Jianing&nbsp;Qi</a><sup>1</sup> Â·
          <a href="https://www.bmcc.cuny.edu/faculty/hao-tang/" target="_blank">Hao&nbsp;Tang</a><sup>2</sup> Â·
          <a href="https://ccvcl.org/professor-zhigang-zhu/" target="_blank">Zhigang&nbsp;Zhu</a><sup>3</sup>
        </p>
        <p class="is-size-7 mb-4">
          <sup>1</sup>CUNY&nbsp;Graduate&nbsp;Center&nbsp;&nbsp;
          <sup>2</sup>BMCC,&nbsp;CUNY&nbsp;&nbsp;
          <sup>3</sup>CCNY,&nbsp;CUNY
        </p>

        <div class="buttons is-centered">
          <a class="button is-dark is-rounded" href="TODO-arxiv" target="_blank"><i class="ai ai-arxiv mr-1"></i>arXiv</a>
          <a class="button is-dark is-rounded" href="TODO-code" target="_blank"><i class="fab fa-github mr-1"></i>Code</a>
          <a class="button is-dark is-rounded" href="TODO-models" target="_blank"><i class="fas fa-database mr-1"></i>Models</a>
        </div>
        
        <figure class="mt-6">
          <img src="./static/images/discrete_dropout.png" alt="PGG teaser figure" loading="lazy" style="width: 80%; border-radius: 10px; border: 1px solid #1f2632;" />
          <figcaption class="is-size-7 has-text-grey mt-2">Experiments on discrete control tasks showed that PGG can improve performance espicially with low training data</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  TL;DR                                                   -->
  <!-- ========================================================= -->
  <section class="section has-background-light">
    <div class="container is-max-desktop content">
      <h2 class="title is-3">TL;DR</h2>
      <ul>
        <li><strong>Guidance for PPO:</strong> We extend CFG to PPO without the need for the diffusion model architecture.
          <!-- Add an unconditional branch Ï€<sub>u</sub>(a) and mix with Ï€<sub>c</sub>(a|s) via Î³ to get Ï€Ì‚(a|s) âˆ Ï€<sub>u</sub><sup>1âˆ’Î³</sup>Â·Ï€<sub>c</sub><sup>Î³</sup>.</li> -->
        <li><strong>One knob at test time:</strong> Tune Î³ to modulate behavior without retraining.</li>
        <li><strong>Discrete vs. continuous:</strong> Dropout helps in simple discrete tasks; for MuJoCo, training with modest Î³&gt;1 is more stable than dropout.</li>
      </ul>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  ABSTRACT                                                -->
  <!-- ========================================================= -->
  <section class="section has-background-light">
    <div class="container is-max-desktop content">
      <h2 class="title is-3">Summary</h2>
      <p>We introduce Policy Gradient Guidance (PGG), a simple extension of classifierâ€‘free guidance from diffusion models to classical policy gradient methods. CFG requires the diffusion model architecture, but we find PPO can be adapted with CFG through score function perspective with weighted policy mixture.
        PGG adds an unconditional policy branch Ï€<sub>u</sub>(a) alongside the standard conditional policy Ï€<sub>c</sub>(a|s), then forms a guided policy Ï€Ì‚(a|s) âˆ Ï€<sub>u</sub>(a)<sup>1âˆ’Î³</sup> Â· Ï€<sub>c</sub>(a|s)<sup>Î³</sup> via a single hyperparameter Î³. This would be the same as the CFG when in the score function perspective.
        It provides a testâ€‘time control knob that modulates behavior without retraining. On discrete control tasks and continuous control (MuJoCo), PGG with moderate Î³ values improves sample efficiency and final performance. The method requires no architecture changes to existing PPO implementations.</p>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  METHOD                                                   -->
  <!-- ========================================================= -->
  <section class="section">
    <div class="container is-max-desktop">
      <h2 class="title is-3">Method in a Nutshell</h2>
      
      <div class="columns">
        <div class="column">
          <p><strong>Guided policy:</strong></p>
          <div class="box has-background-dark has-text-light">
            <p class="has-text-centered is-size-4">Ï€Ì‚(a|s) âˆ Ï€<sub>u</sub>(a)<sup>1âˆ’Î³</sup> Â· Ï€<sub>c</sub>(a|s)<sup>Î³</sup></p>
          </div>
          <p><strong>Guided policy gradient (PG):</strong></p>
          <div class="box has-background-dark has-text-light">
            <p class="has-text-centered is-size-4">âˆ‡J â‰ˆ ğ”¼[A Â· (Î³ âˆ‡log Ï€<sub>c</sub>(a|s) + (1âˆ’Î³) âˆ‡log Ï€<sub>u</sub>(a))]</p>
          </div>
          <div class="notification is-info is-light">
            <p class="is-size-7"><strong>Reference implementation:</strong> <code>Agent.uncond_embed</code> and <code>Agent.guided_dist</code> (discrete), which builds Ï€Ì‚ by combining logâ€‘probs and reâ€‘normalizing with a Categorical distribution.</p>
          </div>
        </div>
        <div class="column">
          <p><strong>Intuition:</strong> Î³ rescales the learned logâ€‘odds Î”(s,a)=log Ï€<sub>c</sub>âˆ’log Ï€<sub>u</sub>. When Î” correlates with advantage, Î³ acts like an inverseâ€‘temperatureâ€”sharpening or relaxing exploitationâ€”<em>without</em> retraining.</p>
          <p class="is-size-7 has-text-grey">Continuous control: means are interpolated per the product form; we share a diagonal logâ€‘std for stability.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  INTERACTIVE DEMO                                         -->
  <!-- ========================================================= -->
  <section class="section has-background-light">
    <div class="container is-max-desktop">
      <h2 class="title is-3">Interactive Demo â€” the Î³ knob</h2>
      <p class="is-size-7 has-text-grey mb-4">Move Î³ to see how the guided distribution Ï€Ì‚ combines unconditional Ï€<sub>u</sub> and conditional Ï€<sub>c</sub>. Values are illustrative.</p>

      <div class="columns">
        <div class="column">
          <h3 class="is-size-5 mb-2">Unconditional Ï€<sub>u</sub></h3>
          <div class="box has-background-dark has-text-light" style="height: 140px; display: flex; align-items: flex-end; gap: 8px; padding: 10px;" id="bars-u">
            <!-- Bars will be generated by JavaScript -->
          </div>
          <div class="is-flex is-justify-content-space-between is-size-7 has-text-grey mt-2">
            <span>A1</span><span>A2</span><span>A3</span><span>A4</span>
          </div>
        </div>
        <div class="column">
          <h3 class="is-size-5 mb-2">Conditional Ï€<sub>c</sub></h3>
          <div class="box has-background-dark has-text-light" style="height: 140px; display: flex; align-items: flex-end; gap: 8px; padding: 10px;" id="bars-c">
            <!-- Bars will be generated by JavaScript -->
          </div>
          <div class="is-flex is-justify-content-space-between is-size-7 has-text-grey mt-2">
            <span>A1</span><span>A2</span><span>A3</span><span>A4</span>
          </div>
        </div>
        <div class="column">
          <h3 class="is-size-5 mb-2">Guided Ï€Ì‚</h3>
          <div class="box has-background-dark has-text-light" style="height: 140px; display: flex; align-items: flex-end; gap: 8px; padding: 10px;" id="bars-g">
            <!-- Bars will be generated by JavaScript -->
          </div>
          <div class="is-flex is-justify-content-space-between is-size-7 has-text-grey mt-2">
            <span>A1</span><span>A2</span><span>A3</span><span>A4</span>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <label for="gamma" class="is-size-6">Î³ = <span id="gammaVal">1.00</span></label>
        <input id="gamma" type="range" min="0" max="2" value="1" step="0.01" style="width: 240px; vertical-align: middle; margin-left: 8px;">
        <span class="is-size-7 has-text-grey ml-2">Ï€Ì‚ logits = (1âˆ’Î³)Â·log Ï€<sub>u</sub> + Î³Â·log Ï€<sub>c</sub></span>
      </div>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  RESULTS â€“                                               -->
  <!-- ========================================================= -->
  <section class="section" id="results">
    <div class="container is-max-desktop">
      <h2 class="title is-3">Results</h2>
      
      <div class="columns">
        <div class="column">
          <div class="box">
            <h4 class="is-size-5 mb-2"><strong>CartPoleâ€‘v1</strong></h4>
            <p class="is-size-7 has-text-grey mb-3">n=5 seeds â€¢ earlyâ€‘phase AUC â†‘ with larger Î³; asymptotics similar.</p>
            <img src="./static/images/all_model_comparison.png" alt="CartPole result" style="width:100%; border-radius:8px; border:1px solid #1f2632">
          </div>
        </div>
        <div class="column">
          <div class="box">
            <h4 class="is-size-5 mb-2"><strong>Hopperâ€‘v4</strong></h4>
            <p class="is-size-7 has-text-grey mb-3">Moderate Î³âˆˆ[1.05,1.2] improves midâ€‘training; too large Î³ destabilizes.</p>
            <img src="./static/images/inference_size_comparison.png" alt="Hopper result" style="width:100%; border-radius:8px; border:1px solid #1f2632">
          </div>
        </div>
        <div class="column">
          <div class="box">
            <h4 class="is-size-5 mb-2"><strong>Humanoidâ€‘v4</strong></h4>
            <p class="is-size-7 has-text-grey mb-3">Best with Î³â‰ˆ1.1â€“1.2; degradation for Î³â‰«1.2.</p>
            <img src="./static/images/all_model_comparison.png" alt="Humanoid result" style="width:100%; border-radius:8px; border:1px solid #1f2632">
          </div>
        </div>
      </div>
      
      <p class="is-size-7 has-text-grey mt-4">Logs & scripts: <a href="TODO-logs">TensorBoard/W&B</a> â€¢ Eval videos â€¢ Seeds, CI, and SPS tables.</p>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  REPRODUCIBILITY                                         -->
  <!-- ========================================================= -->
  <section class="section has-background-light">
    <div class="container is-max-desktop">
      <h2 class="title is-3">Reproducibility</h2>
      <div class="columns">
        <div class="column">
          <ol>
            <li><code>conda create -n pgg python=3.10 && conda activate pgg</code></li>
            <li><code>pip install torch gymnasium[box2d] tyro tensorboard</code></li>
            <li><code>python ppo_cfg.py --env_id CartPole-v1 --use_cfg True --cfg_gamma 1.1 --cfg_dropout_p 0.0</code></li>
            <li>For a Î³ sweep at eval: set <code>agent.eval_cfg_gamma</code> before evaluation.</li>
          </ol>
          <p class="is-size-7 has-text-grey">Reference code points: <code>Agent.uncond_embed</code> (learnable "null" state) and <code>Agent.guided_dist</code> (logâ€‘prob mix + Categorical reâ€‘norm).</p>
        </div>
        <div class="column">
          <pre><code># Minimal usage (discrete)
action, logp, ent, V = agent.act_and_eval_guided(
    obs, gamma=1.15, use_cfg=True, dropout_p=0.0, dropout_active=False)

# Inside PPO updates:
_, newlogprob, entropy, newvalue = agent.act_and_eval_guided(
    batch_obs, gamma=args.cfg_gamma, use_cfg=args.use_cfg,
    dropout_p=args.cfg_dropout_p, dropout_active=True, action=batch_actions)</code></pre>
        </div>
      </div>
    </div>
  </section>


  <!-- ========================================================= -->
  <!--  FAQ                                                      -->
  <!-- ========================================================= -->
  <section class="section has-background-light">
    <div class="container is-max-desktop content">
      <h2 class="title is-3">FAQ</h2>
      <p><strong>What does Î³ control?</strong> It rescales Î”(s,a)=log Ï€<sub>c</sub>âˆ’log Ï€<sub>u</sub>, acting like an inverse temperature on the learned logâ€‘odds. Moderate Î³ often sharpens good actions; too large Î³ can destabilize highâ€‘dimensional control.</p>
      <p><strong>Is this just KLâ€‘toâ€‘prior RL?</strong> They connect: if Î”â‰ˆÎºÂ·A, PGG â‰ˆ controlâ€‘asâ€‘inference with Î±â‰ˆ1/(Î³Îº). But PGG provides a direct <em>testâ€‘time</em> Î³ knob and an advantageâ€‘weighted coupling between branches.</p>
      <p><strong>Compute overhead?</strong> Training â‰ˆ2Ã— actor forward (two branches). At inference, you can preâ€‘compute Ï€<sub>u</sub> or share layers to keep overhead small.</p>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  BIBTEX                                                   -->
  <!-- ========================================================= -->
  <section class="section" id="bibtex">
    <div class="container is-max-desktop content">
      <h2 class="title is-3">Citation</h2>
      <pre id="bib"><code>@inproceedings{yourkey2025pgg,
  title     = {Policy Gradient Guidance Enables Test Time Control},
  author    = {Your, Name and Coauthor, A.},
  booktitle = {NeurIPS 2025 Workshop on ARLET},
  year      = {2025},
  note      = {arXiv:TODO}
}</code></pre>
      <button class="button is-dark" onclick="copyBib()">Copy BibTeX</button>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  TEAM                                                     -->
  <!-- ========================================================= -->
  <section class="section">
    <div class="container is-max-desktop content">
      <h2 class="title is-3">Team</h2>
      <p>Authors Â· Affiliation Â· Contact: <a href="mailto:TODO@university.edu">TODO@university.edu</a></p>
      <p class="is-size-7 has-text-grey">Acknowledgments: Thank collaborators and funding here.</p>
    </div>
  </section>

  <!-- ========================================================= -->
  <!--  FOOTER                                                   -->
  <!-- ========================================================= -->
  <footer class="footer">
    <div class="content has-text-centered is-size-7">
      <p>Â© 2025 â€¢ PGG project â€¢ <a href="TODO-license">Code License</a></p>
    </div>
  </footer>

  <!-- ========================================================= -->
  <!--  JAVASCRIPT FOR INTERACTIVE DEMO                         -->
  <!-- ========================================================= -->
  <script>
    // --- Simple Î³ demo (discrete) ---
    const pu = [0.25, 0.25, 0.25, 0.25];        // unconditional prior (toy)
    const pc = [0.05, 0.10, 0.25, 0.60];        // conditional policy (toy)
    const barsU = document.getElementById('bars-u');
    const barsC = document.getElementById('bars-c');
    const barsG = document.getElementById('bars-g');
    const gamma = document.getElementById('gamma');
    const gammaVal = document.getElementById('gammaVal');

    function softmax(logits){
      const m = Math.max(...logits);
      const exps = logits.map(v => Math.exp(v - m));
      const Z = exps.reduce((a,b)=>a+b,0);
      return exps.map(v => v/Z);
    }
    function log(x){ return Math.log(Math.max(x, 1e-12)); }

    function renderBars(container, probs){
      container.innerHTML = '';
      probs.forEach(p=>{
        const h = Math.max(4, Math.round(p*120)); // px
        const bar = document.createElement('div');
        bar.className='bar';
        bar.style.height = h + 'px';
        bar.style.width = '28px';
        bar.style.background = 'linear-gradient(180deg, #34d399, #60a5fa)';
        bar.style.borderRadius = '6px 6px 0 0';
        container.appendChild(bar);
      });
    }

    function update(){
      const g = parseFloat(gamma.value);
      gammaVal.textContent = g.toFixed(2);
      // Guided: log p^ = (1-g) log pu + g log pc -> softmax for stability
      const logPu = pu.map(log);
      const logPc = pc.map(log);
      const guidedLog = logPu.map((v,i)=> (1-g)*v + g*logPc[i]);
      const phat = softmax(guidedLog);
      renderBars(barsU, pu);
      renderBars(barsC, pc);
      renderBars(barsG, phat);
    }
    gamma.addEventListener('input', update);
    update();

    // Copy BibTeX
    function copyBib(){
      const text = document.getElementById('bib').innerText;
      navigator.clipboard.writeText(text);
      alert('BibTeX copied!');
    }
  </script>

</body>
</html>
